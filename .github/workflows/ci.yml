name: Pipeline SNMP CI/CD

# Déclenchement : Quand on push sur main ou preprod
on:
  push:
    branches: [ "main", "preprod" ]
  pull_request:
    branches: [ "main", "preprod" ]

jobs:
  test-quality:
    runs-on: ubuntu-latest

    steps:
    # 1. Récupération du code
    - name: Checkout du code
      uses: actions/checkout@v3

    # 2. Installation de Python
    - name: Installation Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    # 3. Installation des dépendances
    - name: Installation des librairies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    # 4. Analyse de la qualité du code (Linting)
    # On vérifie la syntaxe mais on ignore les erreurs d'import graphiques (Flet)
    # et on gère le dossier avec espaces "API + BDD"
    - name: Analyse Pylint
      run: |
        # On définit le PYTHONPATH pour inclure le dossier API
        export PYTHONPATH=$PYTHONPATH:"$(pwd)/API + BDD"
        
        # Analyse du sniffer (RECEIVER)
        pylint --disable=C,R,W0703,E0401 "RECEIVER/snmp_sniffer_mt.py" || true
        
        # Analyse de l'API (API + BDD)
        pylint --disable=C,R,W0703,E0401 "API + BDD/snmp_api_improved.py" || true

    # 5. Lancement des Tests Unitaires
    - name: Tests Unitaires (BDD & Logique)
      run: |
        # Important : on ajoute le dossier avec espaces au Path pour les tests
        export PYTHONPATH=$PYTHONPATH:"$(pwd)/API + BDD"
        
        # Lancement des tests
        python -m unittest discover tests