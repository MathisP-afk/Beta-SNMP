name: Pipeline SNMP CI/CD

on:
  push:
    branches: [ "main", "preprod" ]
  pull_request:
    branches: [ "main", "preprod" ]

jobs:
  qualite-code:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout du code
      uses: actions/checkout@v4

    - name: Installation Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Installation des dependances
      run: |
        python -m pip install --upgrade pip
        pip install -r RECEIVER/requirements.txt
        pip install -r Centrale_SQLIte/requirements.txt
        pip install -r Central_Postgre/requirements.txt
        pip install pylint

    - name: Analyse Pylint - Collecteur SNMP
      run: pylint --disable=C,R,W0703,E0401 "RECEIVER/snmp_collector_unified.py" || true

    - name: Analyse Pylint - API SQLite
      run: pylint --disable=C,R,W0703,E0401 "Centrale_SQLIte/snmp_api_improved.py" || true

    - name: Analyse Pylint - API PostgreSQL
      run: pylint --disable=C,R,W0703,E0401 "Central_Postgre/snmp_api_improved_postgre.py" || true

    - name: Tests unitaires - Collecteur unifie
      run: |
        export PYTHONPATH="$(pwd)/RECEIVER"
        python -m unittest tests/test_snmp_collector_unified.py -v

    - name: Tests unitaires - Centrale SQLite
      run: |
        export PYTHONPATH="$(pwd)/Centrale_SQLIte"
        python -m unittest tests/test_centrale_sqlite.py -v

    - name: Tests unitaires - Centrale PostgreSQL
      run: |
        export PYTHONPATH="$(pwd)/Central_Postgre"
        python -m unittest tests/test_centrale_postgre.py -v

    - name: Tests unitaires - Alertes SMS
      run: |
        export PYTHONPATH="$(pwd)/Centrale_SQLIte"
        python -m unittest tests/test_sms_alerter.py -v
